trigger:
  branches:
    include:
      - main
  paths:
    include:
      - src/*
      - azure-pipelines/*demo.yml

pool:
  name: Continuous Integration
  demands:
    - Agent.OS -equals Linux
    - AZP_RUNS -equals ngx-twcss-demo

parameters:
  - name: ReleaseTag
    type: string
    default: "latest"
    values:
      - "latest"
      - "next"
      - "insiders"
    displayName: "Release Tag"

stages:
  - stage: CI
    jobs:
      - job: Build
        steps:
          - checkout: self
            clean: false
            persistCredentials: true

          - bash: |
              sed "/file\:dist\/ngx-twcss/d" -i package.json
              npm install ngx-twcss@${{ parameters.ReleaseTag }}
              if [ -f package-lock.json ]; echo "Removing package-lock.json"; then rm package-lock.json; fi
              npm install
            displayName: "Setup"

          - script: |
              npm run build:demo
            displayName: "Build"

          - publish: $(Build.SourcesDirectory)/dist/ngx-twcss-demo
            artifact: drop
            displayName: "Publish artifact"

  - ${{ if eq(variables['Build.SourceBranchName'], 'main') }}:
    - stage: CD
      dependsOn: CI
      jobs:
        - job: Release
          steps:
            - checkout: none

            - download: current
              artifact: drop
              displayName: Download build artifact

            - script: |
                # Swap blue/green
                cp -rfp /azp/www/ngx-twcss/green/* /azp/www/ngx-twcss/blue
                # Copy the new release to the green directory
                cp -rfp ./* /azp/www/ngx-twcss/green
              displayName: "Release demo@${{ parameters.ReleaseTag }}"
              workingDirectory: $(Pipeline.Workspace)/drop
